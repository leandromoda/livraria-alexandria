{
  "database": {
    "name": "books.db",
    "path": "livraria-alexandria/scripts/data/books.db",
    "engine": "SQLite",
    "purpose": "Staging local para ingest, enriquecimento, classificação editorial e preparação antes de publicação",
    "resume_capability": true,
    "uuid_strategy": "hex_24_non_uuid",
    "publish_blocker": "uuid_format_mismatch"
  },

  "tables": [
    {
      "name": "livros",
      "primary_key": "id",
      "description": "Staging consolidado com enriquecimento editorial e validação semântica",

      "fields": [

        { "name": "id", "type": "TEXT" },
        { "name": "titulo", "type": "TEXT" },
        { "name": "slug", "type": "TEXT", "unique": true },
        { "name": "autor", "type": "TEXT" },
        { "name": "descricao", "type": "TEXT" },
        { "name": "isbn", "type": "TEXT", "index": true },
        { "name": "ano_publicacao", "type": "INTEGER" },
        { "name": "imagem_url", "type": "TEXT" },

        {
          "name": "idioma",
          "type": "TEXT",
          "format": "ISO-2 upper",
          "examples": ["PT", "EN", "ES", "IT"]
        },

        { "name": "cluster", "type": "TEXT" },

        {
          "name": "fonte",
          "type": "TEXT",
          "values": [
            "openlibrary",
            "google_books",
            "manual",
            "import_csv"
          ]
        },

        {
          "name": "is_book",
          "type": "INTEGER",
          "default": 1,
          "description": "1 livro | 0 não-livro"
        },

        {
          "name": "editorial_score",
          "type": "INTEGER",
          "range": "-5 → +5",
          "publish_threshold": ">= 0"
        },

        { "name": "status_slug", "type": "INTEGER", "default": 0 },
        { "name": "status_dedup", "type": "INTEGER", "default": 0 },
        { "name": "status_synopsis", "type": "INTEGER", "default": 0 },
        { "name": "status_review", "type": "INTEGER", "default": 0 },
        { "name": "status_cover", "type": "INTEGER", "default": 0 },
        { "name": "status_publish", "type": "INTEGER", "default": 0 },

        { "name": "created_at", "type": "DATETIME" },
        { "name": "updated_at", "type": "DATETIME" }
      ]
    },

    {
      "name": "dedup_log",
      "primary_key": "id",
      "fields": [
        { "name": "id", "type": "TEXT" },
        { "name": "livro_id_origem", "type": "TEXT" },
        { "name": "livro_id_duplicado", "type": "TEXT" },
        { "name": "criterio", "type": "TEXT" },
        { "name": "acao", "type": "TEXT" },
        { "name": "created_at", "type": "DATETIME" }
      ]
    },

    {
      "name": "ingest_runs",
      "primary_key": "id",
      "fields": [
        { "name": "id", "type": "TEXT" },
        { "name": "idioma_base", "type": "TEXT" },
        { "name": "pacote", "type": "INTEGER" },
        { "name": "clusters_usados", "type": "TEXT" },
        { "name": "inseridos", "type": "INTEGER" },
        { "name": "skips", "type": "INTEGER" },
        {
          "name": "idioma_detectado_ratio",
          "type": "TEXT",
          "description": "ex: PT:82% | EN:10%"
        },
        { "name": "created_at", "type": "DATETIME" }
      ]
    },

    {
      "name": "pipeline_state",
      "primary_key": "key",
      "fields": [
        { "name": "key", "type": "TEXT" },
        { "name": "value", "type": "TEXT" },
        { "name": "updated_at", "type": "DATETIME" }
      ]
    }
  ],

  "indexes": [

    { "table": "livros", "fields": ["slug"], "unique": true },
    { "table": "livros", "fields": ["isbn"] },
    { "table": "livros", "fields": ["cluster"] },
    { "table": "livros", "fields": ["status_publish"] },
    { "table": "livros", "fields": ["is_book"] },

    {
      "table": "livros",
      "fields": [
        "status_review",
        "idioma",
        "is_book"
      ],
      "description": "Gate editorial + idioma"
    }
  ],

  "quality_gate": {
    "language": {
      "block_unknown": true,
      "block_divergent": true
    },
    "editorial": {
      "require_is_book": true,
      "block_non_book": true,
      "min_editorial_score": 0
    }
  },

  "publish_layer": {
    "target": "Supabase.livros",
    "mode": "REST upsert",
    "status": "blocked",
    "blocking_issue": "invalid input syntax for type uuid"
  }
}