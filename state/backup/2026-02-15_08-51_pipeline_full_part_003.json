timeout=30)\n\n\ndef log(msg):\n    now = datetime.now().strftime(\"%H:%M:%S\")\n    print(f\"[{now}] {msg}\")\n\n\n# =========================\n# CONFIG\n# =========================\n\nOLLAMA_URL = \"http://localhost:11434/api/generate\"\nMODEL = \"phi3:mini\"\n\nMAX_RETRIES = 3\n\n\n# =========================\n# PROMPT\n# =========================\n\ndef build_prompt(titulo, autor):\n\n    autor = autor or \"Autor não informado\"\n\n    return f\"\"\"\nEscreva uma sinopse editorial curta (até 80 palavras)\npara página de recomendação de livros.\n\nTom: informativo + persuasivo\nFoco: valor do livro para o leitor\nSem spoilers\nSem citações\n\nLivro: {titulo}\nAutor: {autor}\n\"\"\"\n\n\n# =========================\n# LLM CALL\n# =========================\n\ndef generate_synopsis(titulo, autor):\n\n    prompt = build_prompt(titulo, autor)\n\n    for attempt in range(MAX_RETRIES):\n\n        try:\n\n            res = requests.post(\n                OLLAMA_URL,\n                json={\n                    \"model\": MODEL,\n                    \"prompt\": prompt,\n                    \"stream\": False,\n                    \"options\": {\n                        \"temperature\": 0.4,\n                        \"num_predict\": 180\n                    }\n                },\n                timeout=120\n            )\n\n            text = res.json()[\"response\"].strip()\n\n            if len(text) > 30:\n                return text\n\n        except Exception:\n            log(f\"Retry LLM ({attempt+1}) → {titulo}\")\n            time.sleep(2)\n\n    return None\n\n\n# =========================\n# FETCH PENDENTES\n# =========================\n\ndef fetch_pending(limit):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        SELECT id, titulo, autor\n        FROM livros\n        WHERE status_synopsis = 0\n        LIMIT ?\n    \"\"\", (limit,))\n\n    rows = cur.fetchall()\n    conn.close()\n\n    return rows\n\n\n# =========================\n# UPDATE\n# =========================\n\ndef update_synopsis(book_id, text):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        UPDATE livros\n        SET\n            descricao = ?,\n            status_synopsis = 1,\n            updated_at = ?\n        WHERE id = ?\n    \"\"\", (\n        text,\n        datetime.utcnow(),\n        book_id\n    ))\n\n    conn.commit()\n    conn.close()\n\n\n# =========================\n# RUN\n# =========================\n\ndef run(pacote=10):\n\n    rows = fetch_pending(pacote)\n\n    if not rows:\n        log(\"Nada pendente para sinopse.\")\n        return\n\n    processed = 0\n    failed = 0\n\n    for book_id, titulo, autor in rows:\n\n        log(f\"LLM → {titulo}\")\n\n        synopsis = generate_synopsis(titulo, autor)\n\n        if not synopsis:\n            failed += 1\n            log(f\"FALHA → {titulo}\")\n            continue\n\n        update_synopsis(book_id, synopsis)\n\n        processed += 1\n        log(f\"SINOPSE OK → {titulo}\")\n\n    log(\n        f\"SINOPSE CONCLUÍDO → {processed} | falhas {failed}\"\n    )\n",
    "scripts\\steps\\_clusters.py": "# ============================================\n# LIVRARIA ALEXANDRIA — CLUSTERS EDITORIAIS\n# Classificação bibliográfica expandida\n# ============================================\n\nCLUSTERS = {\n\n    # ========================================\n    # ECONOMIA & FINANÇAS\n    # ========================================\n\n    \"economics\": [\n        \"economics\",\n        \"political economy\",\n        \"macroeconomics\",\n        \"microeconomics\",\n        \"international economics\",\n        \"economic policy\",\n        \"development economics\",\n        \"public economics\",\n        \"monetary economics\",\n        \"economic history\"\n    ],\n\n    \"finance\": [\n        \"finance\",\n        \"corporate finance\",\n        \"public finance\",\n        \"financial markets\",\n        \"financial management\",\n        \"financial risk management\",\n        \"behavioral finance\",\n        \"investment banking\",\n        \"financial regulation\",\n        \"capital markets\"\n    ],\n\n    \"investments\": [\n        \"investing\",\n        \"investment analysis\",\n        \"portfolio management\",\n        \"value investing\",\n        \"stock market\",\n        \"equity investing\",\n        \"wealth management\",\n        \"asset allocation\",\n        \"hedge funds\",\n        \"private equity\"\n    ],\n\n    \"personal_finance\": [\n        \"personal finance\",\n        \"financial planning\",\n        \"wealth building\",\n        \"retirement planning\",\n        \"financial independence\",\n        \"money management\",\n        \"budgeting\",\n        \"debt management\",\n        \"financial literacy\",\n        \"passive income\"\n    ],\n\n    # ========================================\n    # NEGÓCIOS & GESTÃO\n    # ========================================\n\n    \"business\": [\n        \"business\",\n        \"business administration\",\n        \"business management\",\n        \"international business\",\n        \"family business\",\n        \"small business\",\n        \"business operations\",\n        \"business models\",\n        \"corporate governance\",\n        \"business ethics\"\n    ],\n\n    \"strategy\": [\n        \"business strategy\",\n        \"corporate strategy\",\n        \"competitive strategy\",\n        \"strategic planning\",\n        \"strategic management\",\n        \"military strategy\",\n        \"innovation strategy\",\n        \"growth strategy\",\n        \"market strategy\",\n        \"platform strategy\"\n    ],\n\n    \"management\": [\n        \"management\",\n        \"organizational management\",\n        \"operations management\",\n        \"project management\",\n        \"change management\",\n        \"performance management\",\n        \"risk management\",\n        \"quality management\",\n        \"process management\",\n        \"lean management\"\n    ],\n\n    \"leadership\": [\n        \"leadership\",\n        \"executive leadership\",\n        \"transformational leadership\",\n        \"servant leadership\",\n        \"organizational leadership\",\n        \"team leadership\",\n        \"strategic leadership\",\n        \"leadership development\",\n        \"decision leadership\",\n        \"crisis leadership\"\n    ],\n\n    # ========================================\n    # EMPREENDEDORISMO\n    # ========================================\n\n    \"entrepreneurship\": [\n        \"entrepreneurship\",\n        \"startups\",\n        \"venture capital\",\n        \"innovation management\",\n        \"business innovation\",\n        \"founder mindset\",\n        \"startup strategy\",\n        \"scaling startups\",\n        \"product-market fit\",\n        \"entrepreneurial finance\"\n    ],\n\n    \"innovation\": [\n        \"innovation\",\n        \"disruptive innovation\",\n        \"technology innovation\",\n        \"innovation ecosystems\",\n        \"innovation strategy\",\n        \"product innovation\",\n        \"design thinking\",\n        \"business experimentation\",\n        \"innovation leadership\",\n        \"digital transformation\"\n    ],\n\n    # ========================================\n    # DECISÃO & COMPORTAMENTO\n    # ========================================\n\n    \"decision_making\": [\n        \"decision making\",\n        \"managerial decision making\",\n        \"strategic decision making\",\n        \"decision analysis\",\n        \"decision theory\",\n        \"decision science\",\n        \"complex decision making\",\n        \"data driven decision making\",\n        \"risk decision making\",\n        \"executive decisions\"\n    ],\n\n    \"behavioral_economics\": [\n        \"behavioral economics\",\n        \"behavioral finance\",\n        \"economic psychology\",\n        \"choice architecture\",\n        \"bounded rationality\",\n        \"prospect theory\",\n        \"nudging\",\n        \"cognitive biases\",\n        \"heuristics\",\n        \"experimental economics\"\n    ],\n\n    \"psychology_business\": [\n        \"business psychology\",\n        \"organizational psychology\",\n        \"industrial psychology\",\n        \"consumer psychology\",\n        \"economic psychology\",\n        \"workplace psychology\",\n        \"behavioral decision making\",\n        \"motivation psychology\",\n        \"performance psychology\",\n        \"negotiation psychology\"\n    ],\n\n    # ========================================\n    # PRODUTIVIDADE & EXECUÇÃO\n    # ========================================\n\n    \"productivity\": [\n        \"productivity\",\n        \"time management\",\n        \"personal productivity\",\n        \"focus\",\n        \"deep work\",\n        \"goal setting\",\n        \"execution\",\n        \"workflow optimization\",\n        \"high performance\",\n        \"self management\"\n    ],\n\n    \"habits\": [\n        \"habits\",\n        \"behavior change\",\n        \"habit formation\",\n        \"self discipline\",\n        \"routine building\",\n        \"personal development\",\n        \"success habits\",\n        \"mindset\",\n        \"self improvement\",\n        \"life design\"\n    ],\n\n    # ========================================\n    # FILOSOFIA APLICADA\n    # ========================================\n\n    \"philosophy\": [\n        \"philosophy\",\n        \"practical philosophy\",\n        \"applied philosophy\",\n        \"philosophy of economics\",\n        \"philosophy of business\",\n        \"modern philosophy\",\n        \"classical philosophy\",\n        \"rationalism\",\n        \"empiricism\",\n        \"existentialism\"\n    ],\n\n    \"stoicism\": [\n        \"stoicism\",\n        \"stoic philosophy\",\n        \"roman stoicism\",\n        \"practical stoicism\",\n        \"stoic ethics\",\n        \"stoic leadership\",\n        \"stoic resilience\",\n        \"stoic mindset\",\n        \"epictetus\",\n        \"seneca philosophy\"\n    ],\n\n    \"ethics\": [\n        \"ethics\",\n        \"business ethics\",\n        \"economic ethics\",\n        \"corporate ethics\",\n        \"moral philosophy\",\n        \"applied ethics\",\n        \"virtue ethics\",\n        \"leadership ethics\",\n        \"professional ethics\",\n        \"ethics decision making\"\n    ],\n\n    \"political_philosophy\": [\n        \"political philosophy\",\n        \"political economy\",\n        \"liberalism\",\n        \"capitalism\",\n        \"socialism\",\n        \"libertarianism\",\n        \"state theory\",\n        \"governance theory\",\n        \"public choice\",\n        \"freedom philosophy\"\n    ],\n\n    # ========================================\n    # BIOGRAFIA & HISTÓRIA EMPRESARIAL\n    # ========================================\n\n    \"biography_business\": [\n        \"business biography\",\n        \"entrepreneur biography\",\n        \"founder biography\",\n        \"executive biography\",\n        \"corporate history\",\n        \"company history\",\n        \"startup biography\",\n        \"investor biography\",\n        \"ceo biography\",\n        \"business memoir\"\n    ],\n\n    \"economic_history\": [\n        \"economic history\",\n        \"financial history\",\n        \"history of capitalism\",\n        \"history of markets\",\n        \"industrial history\",\n        \"banking history\",\n        \"trade history\",\n        \"corporate history\",\n        \"global economic history\",\n        \"history of economic thought\"\n    ]\n}\n",
    "scripts\\_backup\\ingest_books.py": "import requests\nimport uuid\nimport re\nimport unicodedata\nimport time\nimport threading\nfrom datetime import datetime\n\n# =========================\n# CONFIG\n# =========================\n\nSUPABASE_URL = \"https://ncnexkuiiuzwujqurtsa.supabase.co\"\nSUPABASE_KEY = \"SUA_SERVICE_ROLE_KEY\"\n\nHEADERS = {\n    \"apikey\": SUPABASE_KEY,\n    \"Authorization\": f\"Bearer {SUPABASE_KEY}\",\n    \"Content-Type\": \"application/json\"\n}\n\nOPENLIBRARY_SEARCH_URL = \"https://openlibrary.org/search.json\"\nOPENLIBRARY_BASE_URL = \"https://openlibrary.org\"\nGOOGLE_BOOKS_URL = \"https://www.googleapis.com/books/v1/volumes\"\n\nOLLAMA_URL = \"http://localhost:11434/api/generate\"\nMODEL = \"phi3:mini\"\n\nLIMIT_PER_QUERY = 10\n\nQUERIES = [\n    \"finance\",\"investing\",\"personal finance\",\"wealth\",\n    \"entrepreneurship\",\"business strategy\",\n    \"psychology\",\"behavioral economics\",\n    \"decision making\",\"habits\",\"productivity\",\n    \"stoicism\",\"philosophy\",\"ethics\",\n    \"political philosophy\",\"strategy\",\n    \"biography business\",\"entrepreneur biography\",\n    \"leadership\",\"management\",\n]\n\nlast_activity = time.time()\n\n# =========================\n# LOGGER\n# =========================\n\ndef log(msg):\n    now = datetime.now().strftime(\"%H:%M:%S\")\n    print(f\"[{now}] {msg}\")\n\n# =========================\n# HEARTBEAT\n# =========================\n\ndef heartbeat():\n    while True:\n        elapsed = int(time.time() - last_activity)\n        log(f\"Script ativo… último evento há {elapsed}s\")\n        time.sleep(30)\n\nthreading.Thread(target=heartbeat, daemon=True).start()\n\n# =========================\n# SLUG\n# =========================\n\ndef slugify(text):\n    text = unicodedata.normalize(\"NFKD\", text)\n    text = text.encode(\"ascii\", \"ignore\").decode(\"ascii\")\n    text = text.lower()\n    text = re.sub(r\"[^a-z0-9\\s-]\", \"\", text)\n    text = re.sub(r\"\\s+\", \"-\", text)\n    return text.strip(\"-\")\n\n# =========================\n# FILTRO\n# =========================\n\nEXCLUDED_TERMS = [\n    \"laws\",\"law\",\"bill\",\"act\",\"court\",\n    \"audit\",\"administration\",\"report\",\n    \"government\",\"committee\"\n]\n\ndef is_valid_book(doc):\n\n    title = (doc.get(\"title\") or \"\").lower()\n    authors = doc.get(\"author_name\")\n    edition_count = doc.get(\"edition_count\", 0)\n\n    if len(title) < 5:\n        return False\n\n    if not authors:\n        return False\n\n    if edition_count < 2:\n        return False\n\n    for term in EXCLUDED_TERMS:\n        if term in title:\n            return False\n\n    return True\n\n# =========================\n# DEDUP CORRIGIDO\n# =========================\n\ndef book_exists(slug, isbn):\n\n    url = f\"{SUPABASE_URL}/rest/v1/livros\"\n\n    # ---- slug check\n    res_slug = requests.get(\n        url,\n        headers=HEADERS,\n        params={\n            \"select\": \"id\",\n            \"slug\": f\"eq.{slug}\"\n        }\n    )\n\n    data_slug = res_slug.json()\n\n    if data_slug:\n        log(f\"SKIP slug → {slug}\")\n        return True\n\n    # ---- isbn check\n    if isbn:\n\n        res_isbn = requests.get(\n            url,\n            headers=HEADERS,\n            params={\n                \"select\": \"id\",\n                \"isbn\": f\"eq.{isbn}\"\n            }\n        )\n\n        data_isbn = res_isbn.json()\n\n        if data_isbn:\n            log(f\"SKIP isbn → {isbn}\")\n            return True\n\n    return False\n\n# =========================\n# FETCH\n# =========================\n\ndef fetch_by_query(query):\n\n    log(f\"QUERY → {query}\")\n\n    res = requests.get(\n        OPENLIBRARY_SEARCH_URL,\n        params={\"q\": query, \"limit\": LIMIT_PER_QUERY * 3}\n    )\n\n    docs = res.json().get(\"docs\", [])\n\n    filtered = [\n        d for d in docs if is_valid_book(d)\n    ][:LIMIT_PER_QUERY]\n\n    log(f\"{query} → {len(filtered)} válidos\")\n\n    return filtered\n\n# =========================\n# METADATA OL\n# =========================\n\ndef enrich_openlibrary(work_key):\n\n    if not work_key:\n        return {}\n\n    url = f\"{OPENLIBRARY_BASE_URL}{work_key}/editions.json?limit=5\"\n    res = requests.get(url)\n\n    if res.status_code != 200:\n        return {}\n\n    data = res.json()\n\n    isbn = None\n    year = None\n    cover = None\n\n    for ed in data.get(\"entries\", []):\n\n        isbn_list = ed.get(\"isbn_13\") or ed.get(\"isbn_10\")\n        if isbn_list:\n            isbn = isbn_list[0]\n\n        if ed.get(\"publish_date\"):\n            m = re.search(r\"\\d{4}\", ed[\"publish_date\"])\n            if m:\n                year = m.group(0)\n\n        cover_id = ed.get(\"covers\", [None])[0]\n        if cover_id:\n            cover = f\"https://covers.openlibrary.org/b/id/{cover_id}-L.jpg\"\n\n        if isbn and year and cover:\n            break\n\n    return {\n        \"isbn\": isbn,\n        \"ano_publicacao\": year,\n        \"imagem_url\": cover,\n    }\n\n# =========================\n# GOOGLE FALLBACK\n# =========================\n\ndef enrich_google(title, author):\n\n    query = f\"{title} {author}\"\n\n    res = requests.get(\n        GOOGLE_BOOKS_URL,\n        params={\"q\": query, \"maxResults\": 1}\n    )\n\n    items = res.json().get(\"items\")\n\n    if not items:\n        return {}\n\n    volume = items[0][\"volumeInfo\"]\n\n    isbn = None\n    for ident in volume.get(\"industryIdentifiers\", []):\n        if ident[\"type\"] in [\"ISBN_13\",\"ISBN_10\"]:\n            isbn = ident[\"identifier\"]\n\n    year = None\n    if volume.get(\"publishedDate\"):\n        m = re.search(r\"\\d{4}\", volume[\"publishedDate\"])\n        if m:\n            year = m.group(0)\n\n    cover = volume.get(\"imageLinks\", {}).get(\"thumbnail\")\n\n    return {\n        \"isbn\": isbn,\n        \"ano_publicacao\": year,\n        \"imagem_url\": cover,\n    }\n\n# =========================\n# LLM\n# =========================\n\ndef generate_synopsis(title, author):\n\n    log(f\"LLM → {title}\")\n\n    prompt = f\"\"\"\nSinopse curta (até 60 palavras):\n\n{title} — {author}\n\"\"\"\n\n    res = requests.post(\n        OLLAMA_URL,\n        json={\n            \"model\": MODEL,\n            \"prompt\": prompt,\n            \"stream\": False,\n        }\n    )\n\n    return res.json()[\"response\"].strip()\n\n# =========================\n# INSERT\n# =========================\n\ndef insert_book(payload):\n\n    url = f\"{SUPABASE_URL}/rest/v1/livros\"\n\n    requests.post(\n        url,\n        headers=HEADERS,\n        json=payload\n    )\n\n    log(f\"INSERT → {payload['titulo']}\")\n\n# =========================\n# PIPELINE\n# =========================\n\ndef run():\n\n    total_inserted = 0\n    total_skipped = 0\n\n    for query in QUERIES:\n\n        cluster_inserted = 0\n        cluster_skipped = 0\n\n        books = fetch_by_query(query)\n\n        for b in books:\n\n            titulo = b.get(\"title\")\n            autores = \", \".join(\n                b.get(\"author_name\", [])\n            )\n\n            metadata = enrich_openlibrary(b.get(\"key\"))\n\n            if not metadata.get(\"isbn\") or not metadata.get(\"imagem_url\"):\n                g_meta = enrich_google(titulo, autores)\n                metadata = {**g_meta, **metadata}\n\n            slug = slugify(titulo)\n            isbn = metadata.get(\"isbn\")\n\n            if book_exists(slug, isbn):\n                cluster_skipped += 1\n                total_skipped += 1\n                continue\n\n            descricao = generate_synopsis(titulo, autores)\n\n            payload = {\n                \"id\": str(uuid.uuid4()),\n                \"titulo\": titulo,\n                \"slug\": slug,\n                \"autor\": autores,\n                \"descricao\": descricao,\n                \"isbn\": isbn,\n                \"ano_publicacao\": metadata.get(\"ano_publicacao\"),\n                \"imagem_url\": metadata.get(\"imagem_url\"),\n            }\n\n            insert_book(payload)\n\n            cluster_inserted += 1\n            total_inserted += 1\n\n        log(\n            f\"CLUSTER {query} → +{cluster_inserted} | skip {cluster_skipped}\"\n        )\n\n    log(\"===== RESUMO FINAL =====\")\n    log(f\"INSERTS → {total_inserted}\")\n    log(f\"SKIPS → {total_skipped}\")\n\n# =========================\n# RUN\n# =========================\n\nif __name__ == \"__main__\":\n    run()\n",
    "state\\2026-02-15_08-51_site_bootstrap_part_001.json": "{\n  \"tree_site\": \"app\\napp\\\\(internal)\\napp\\\\(internal)\\\\api\\napp\\\\(internal)\\\\api\\\\click\\napp\\\\(internal)\\\\api\\\\click\\\\[id]\\napp\\\\(public)\\napp\\\\(public)\\\\autores\\napp\\\\(public)\\\\categorias\\napp\\\\(public)\\\\categorias\\\\[slug]\\napp\\\\(public)\\\\listas\\napp\\\\(public)\\\\listas\\\\[slug]\\napp\\\\(public)\\\\listas\\\\[slug]\\\\_components\\napp\\\\(public)\\\\listas\\\\[slug]\\\\_data\\napp\\\\(public)\\\\listas\\\\[slug]\\\\_graph\\napp\\\\(public)\\\\livros\\napp\\\\(public)\\\\livros\\\\[slug]\\napp\\\\(public)\\\\livros\\\\[slug]\\\\_components\\napp\\\\(public)\\\\livros\\\\[slug]\\\\_data\\napp\\\\(public)\\\\livros\\\\[slug]\\\\_graph\\napp\\\\(public)\\\\ofertas\\napp\\\\(public)\\\\ofertas\\\\_components\\napp\\\\(public)\\\\ofertas\\\\_data\\napp\\\\(public)\\\\tags\\napp\\\\teste\\napp\\\\teste\\\\[id]\\nlib\\nlib\\\\supabase\\npublic\",\n  \"project_state\": \"project_state.json não encontrado.\",\n  \"database_schema_abstract\": \"database_schema.json não encontrado.\",\n  \"files\": {\n    \"app\\\\globals.css\": \"@import \\\"tailwindcss\\\";\\n\\n:root {\\n  --background: #ffffff;\\n  --foreground: #171717;\\n}\\n\\n@theme inline {\\n  --color-background: var(--background);\\n  --color-foreground: var(--foreground);\\n  --font-sans: var(--font-geist-sans);\\n  --font-mono: var(--font-geist-mono);\\n}\\n\\n@media (prefers-color-scheme: dark) {\\n  :root {\\n    --background: #0a0a0a;\\n    --foreground: #ededed;\\n  }\\n}\\n\\nbody {\\n  background: var(--background);\\n  color: var(--foreground);\\n  font-family: Arial, Helvetica, sans-serif;\\n}\\n\",\n    \"app\\\\layout.tsx\": \"export const runtime = \\\"edge\\\";\\n\\nimport \\\"./globals.css\\\";\\n\\nexport default function RootLayout({\\n  children,\\n}: {\\n  children: React.ReactNode;\\n}) {\\n  return (\\n    <html lang=\\\"pt-BR\\\">\\n      <body>\\n\\n        {/* =========================\\n            NAVBAR GLOBAL\\n        ========================== */}\\n        <header className=\\\"border-b bg-white\\\">\\n\\n          <nav className=\\\"max-w-6xl mx-auto px-6 py-4 flex gap-6 text-sm font-medium\\\">\\n\\n            <a href=\\\"/\\\" className=\\\"hover:text-blue-600\\\">\\n              Home\\n            </a>\\n\\n            <a href=\\\"/listas\\\" className=\\\"hover:text-blue-600\\\">\\n              Listas\\n            </a>\\n\\n            <a href=\\\"/livros\\\" className=\\\"hover:text-blue-600\\\">\\n              Livros\\n            </a>\\n\\n            <a href=\\\"/ofertas\\\" className=\\\"hover:text-blue-600\\\">\\n              Ofertas\\n            </a>\\n\\n          </nav>\\n\\n        </header>\\n\\n        {/* PAGE */}\\n        <main>\\n          {children}\\n        </main>\\n\\n      </body>\\n    </html>\\n  );\\n}\\n\",\n    \"app\\\\(internal)\\\\api\\\\click\\\\[id]\\\\route.ts\": \"export const runtime = \\\"edge\\\";\\n\\nimport { NextResponse } from \\\"next/server\\\";\\nimport { createClient } from \\\"@supabase/supabase-js\\\";\\n\\nexport async function GET(\\n  req: Request,\\n  { params }: { params: { id: string } }\\n) {\\n  const offerId = params.id;\\n\\n  const supabase = createClient(\\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\\n    process.env.SUPABASE_SERVICE_ROLE_KEY!\\n  );\\n\\n  /**\\n   * 1) Buscar oferta + livro\\n   */\\n  const { data: oferta, error: ofertaError } =\\n    await supabase\\n      .from(\\\"ofertas\\\")\\n      .select(\\\"id, livro_id, url_afiliada\\\")\\n      .eq(\\\"id\\\", offerId)\\n      .single();\\n\\n  if (ofertaError || !oferta) {\\n    return new NextResponse(\\\"Oferta não encontrada\\\", {\\n      status: 404,\\n    });\\n  }\\n\\n  /**\\n   * 2) Metadados\\n   */\\n  const userAgent =\\n    req.headers.get(\\\"user-agent\\\") ?? null;\\n\\n  const referer =\\n    req.headers.get(\\\"referer\\\") ?? null;\\n\\n  const ip =\\n    req.headers.get(\\\"x-forwarded-for\\\") ??\\n    \\\"0.0.0.0\\\";\\n\\n  /**\\n   * 3) Hash IP (Edge-safe)\\n   */\\n  const hashBuffer = await crypto.subtle.digest(\\n    \\\"SHA-256\\\",\\n    new TextEncoder().encode(ip)\\n  );\\n\\n  const ipHash = Array.from(\\n    new Uint8Array(hashBuffer)\\n  )\\n    .map((b) => b.toString(16).padStart(2, \\\"0\\\"))\\n    .join(\\\"\\\");\\n\\n  /**\\n   * 4) Insert tracking\\n   */\\n  await supabase.from(\\\"oferta_clicks\\\").insert({\\n    oferta_id: oferta.id,\\n    livro_id: oferta.livro_id,\\n    user_agent: userAgent,\\n    referer: referer,\\n    ip_hash: ipHash,\\n  });\\n\\n  /**\\n   * 5) Redirect afiliado\\n   */\\n  return NextResponse.redirect(\\n    oferta.url_afiliada,\\n    302\\n  );\\n}\\n\",\n    \"app\\\\(public)\\\\page.tsx\": \"export const runtime = \\