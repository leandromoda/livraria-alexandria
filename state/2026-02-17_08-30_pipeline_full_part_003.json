=====================\n# FETCH PENDENTES\n# =========================\n\ndef fetch_pending(idioma, limit):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        SELECT id, titulo, descricao\n        FROM livros\n        WHERE status_synopsis = 1\n        AND status_review = 0\n        AND idioma = ?\n        LIMIT ?\n    \"\"\", (idioma, limit))\n\n    rows = cur.fetchall()\n    conn.close()\n\n    return rows\n\n\n# =========================\n# UPDATE\n# =========================\n\ndef update_review(book_id, texto, slug):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        UPDATE livros\n        SET\n            descricao = ?,\n            slug = ?,\n            status_review = 1,\n            updated_at = CURRENT_TIMESTAMP\n        WHERE id = ?\n    \"\"\", (texto, slug, book_id))\n\n    conn.commit()\n    conn.close()\n\n\n# =========================\n# RUN\n# =========================\n\ndef run(idioma, pacote=10):\n\n    rows = fetch_pending(idioma, pacote)\n\n    if not rows:\n        log(\n            f\"Nada pendente para revisão \"\n            f\"no idioma [{idioma}].\"\n        )\n        return\n\n    processed = 0\n    failed = 0\n\n    for book_id, titulo, descricao in rows:\n\n        log(f\"REVISANDO → {titulo}\")\n\n        texto_revisto = review_text(descricao)\n\n        if not texto_revisto:\n            failed += 1\n            log(f\"FALHA REVIEW → {titulo}\")\n            continue\n\n        slug_revisto = revise_slug(\n            titulo,\n            book_id\n        )\n\n        update_review(\n            book_id,\n            texto_revisto,\n            slug_revisto\n        )\n\n        processed += 1\n\n        log(f\"REVISADO → {titulo}\")\n\n    log(\n        f\"REVISÃO CONCLUÍDA [{idioma}] → \"\n        f\"{processed} | falhas {failed}\"\n    )\n",
    "scripts\\steps\\slugify.py": "# ============================================\n# LIVRARIA ALEXANDRIA — SLUGIFY\n# Path Safe + Collision Safe\n# ============================================\n\nimport re\nimport unicodedata\n\nfrom datetime import datetime\n\nfrom core.db import get_conn\nfrom core.logger import log\n\n\n# =========================\n# SLUG BASE\n# =========================\n\ndef base_slug(text):\n\n    text = unicodedata.normalize(\"NFKD\", text)\n    text = text.encode(\"ascii\", \"ignore\").decode(\"ascii\")\n    text = text.lower()\n\n    text = re.sub(r\"[^a-z0-9\\s-]\", \"\", text)\n    text = re.sub(r\"\\s+\", \"-\", text)\n\n    return text.strip(\"-\")\n\n\n# =========================\n# CHECK COLISÃO\n# =========================\n\ndef slug_exists(slug):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\n        \"SELECT 1 FROM livros WHERE slug = ? LIMIT 1\",\n        (slug,)\n    )\n\n    exists = cur.fetchone() is not None\n\n    conn.close()\n\n    return exists\n\n\ndef generate_unique_slug(titulo):\n\n    base = base_slug(titulo)\n\n    slug = base\n    counter = 2\n\n    while slug_exists(slug):\n        slug = f\"{base}-{counter}\"\n        counter += 1\n\n    return slug\n\n\n# =========================\n# FETCH PENDENTES\n# =========================\n\ndef fetch_pending(idioma, limit):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        SELECT id, titulo\n        FROM livros\n        WHERE status_slug = 0\n        AND idioma = ?\n        LIMIT ?\n    \"\"\", (idioma, limit))\n\n    rows = cur.fetchall()\n    conn.close()\n\n    return rows\n\n\n# =========================\n# UPDATE\n# =========================\n\ndef update_slug(book_id, slug):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    now = datetime.utcnow().isoformat()\n\n    cur.execute(\"\"\"\n        UPDATE livros\n        SET slug = ?,\n            status_slug = 1,\n            updated_at = ?\n        WHERE id = ?\n    \"\"\", (slug, now, book_id))\n\n    conn.commit()\n    conn.close()\n\n\n# =========================\n# RUN\n# =========================\n\ndef run(idioma, pacote=10):\n\n    rows = fetch_pending(idioma, pacote)\n\n    if not rows:\n        log(\n            f\"Nada pendente para slug \"\n            f\"no idioma [{idioma}].\"\n        )\n        return\n\n    processed = 0\n\n    for book_id, titulo in rows:\n\n        slug = generate_unique_slug(titulo)\n\n        update_slug(book_id, slug)\n\n        processed += 1\n\n        log(f\"SLUG → {titulo} → {slug}\")\n\n    log(\n        f\"SLUG CONCLUÍDO [{idioma}] → \"\n        f\"{processed}\"\n    )\n",
    "scripts\\steps\\synopsis.py": "# ============================================\n# LIVRARIA ALEXANDRIA — SYNOPSIS\n# LLM (Ollama) + Path Safe + Retry Safe\n# ============================================\n\nimport requests\nimport time\n\nfrom datetime import datetime\n\nfrom core.db import get_conn\nfrom core.logger import log\n\n\n# =========================\n# CONFIG\n# =========================\n\nOLLAMA_URL = \"http://localhost:11434/api/generate\"\nMODEL = \"phi3:mini\"\n\nMAX_RETRIES = 3\n\n\n# =========================\n# PROMPT\n# =========================\n\ndef build_prompt(titulo, autor):\n\n    autor = autor or \"Autor não informado\"\n\n    return f\"\"\"\nEscreva uma sinopse editorial curta (até 80 palavras)\npara página de recomendação de livros.\n\nTom: informativo + persuasivo\nFoco: valor do livro para o leitor\nSem spoilers\nSem citações\n\nLivro: {titulo}\nAutor: {autor}\n\"\"\"\n\n\n# =========================\n# LLM CALL\n# =========================\n\ndef generate_synopsis(titulo, autor):\n\n    prompt = build_prompt(titulo, autor)\n\n    for attempt in range(MAX_RETRIES):\n\n        try:\n\n            res = requests.post(\n                OLLAMA_URL,\n                json={\n                    \"model\": MODEL,\n                    \"prompt\": prompt,\n                    \"stream\": False,\n                    \"options\": {\n                        \"temperature\": 0.4,\n                        \"num_predict\": 180\n                    }\n                },\n                timeout=120\n            )\n\n            text = res.json()[\"response\"].strip()\n\n            if len(text) > 30:\n                return text\n\n        except Exception:\n            log(f\"Retry LLM ({attempt+1}) → {titulo}\")\n            time.sleep(2)\n\n    return None\n\n\n# =========================\n# FETCH PENDENTES\n# =========================\n\ndef fetch_pending(idioma, limit):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        SELECT id, titulo, autor\n        FROM livros\n        WHERE status_synopsis = 0\n        AND idioma = ?\n        LIMIT ?\n    \"\"\", (idioma, limit))\n\n    rows = cur.fetchall()\n    conn.close()\n\n    return rows\n\n\n# =========================\n# UPDATE\n# =========================\n\ndef update_synopsis(book_id, text):\n\n    conn = get_conn()\n    cur = conn.cursor()\n\n    cur.execute(\"\"\"\n        UPDATE livros\n        SET\n            descricao = ?,\n            status_synopsis = 1,\n            updated_at = ?\n        WHERE id = ?\n    \"\"\", (\n        text,\n        datetime.utcnow().isoformat(),\n        book_id\n    ))\n\n    conn.commit()\n    conn.close()\n\n\n# =========================\n# RUN\n# =========================\n\ndef run(idioma, pacote=10):\n\n    rows = fetch_pending(idioma, pacote)\n\n    if not rows:\n        log(\n            f\"Nada pendente para sinopse \"\n            f\"no idioma [{idioma}].\"\n        )\n        return\n\n    processed = 0\n    failed = 0\n\n    for book_id, titulo, autor in rows:\n\n        log(f\"LLM → {titulo}\")\n\n        synopsis = generate_synopsis(titulo, autor)\n\n        if not synopsis:\n            failed += 1\n            log(f\"FALHA → {titulo}\")\n            continue\n\n        update_synopsis(book_id, synopsis)\n\n        processed += 1\n        log(f\"SINOPSE OK → {titulo}\")\n\n    log(\n        f\"SINOPSE CONCLUÍDA [{idioma}] → \"\n        f\"{processed} | falhas {failed}\"\n    )\n",
    "scripts\\steps\\_clusters.py": "# ============================================\n# LIVRARIA ALEXANDRIA — CLUSTERS EDITORIAIS\n# Classificação bibliográfica expandida\n# Não-ficção + Ficção\n# ============================================\n\nCLUSTERS = {\n\n    # ========================================\n    # ECONOMIA & FINANÇAS\n    # ========================================\n\n    \"economics\": [\n        \"economics\",\n        \"political economy\",\n        \"macroeconomics\",\n        \"microeconomics\",\n        \"international economics\",\n        \"economic policy\",\n        \"development economics\",\n        \"public economics\",\n        \"monetary economics\",\n        \"economic history\"\n    ],\n\n    \"finance\": [\n        \"finance\",\n        \"corporate finance\",\n        \"public finance\",\n        \"financial markets\",\n        \"financial management\",\n        \"financial risk management\",\n        \"behavioral finance\",\n        \"investment banking\",\n        \"financial regulation\",\n        \"capital markets\"\n    ],\n\n    \"investments\": [\n        \"investing\",\n        \"investment analysis\",\n        \"portfolio management\",\n        \"value investing\",\n        \"stock market\",\n        \"equity investing\",\n        \"wealth management\",\n        \"asset allocation\",\n        \"hedge funds\",\n        \"private equity\"\n    ],\n\n    \"personal_finance\": [\n        \"personal finance\",\n        \"financial planning\",\n        \"wealth building\",\n        \"retirement planning\",\n        \"financial independence\",\n        \"money management\",\n        \"budgeting\",\n        \"debt management\",\n        \"financial literacy\",\n        \"passive income\"\n    ],\n\n    # ========================================\n    # NEGÓCIOS & GESTÃO\n    # ========================================\n\n    \"business\": [\n        \"business\",\n        \"business administration\",\n        \"business management\",\n        \"international business\",\n        \"family business\",\n        \"small business\",\n        \"business operations\",\n        \"business models\",\n        \"corporate governance\",\n        \"business ethics\"\n    ],\n\n    \"strategy\": [\n        \"business strategy\",\n        \"corporate strategy\",\n        \"competitive strategy\",\n        \"strategic planning\",\n        \"strategic management\",\n        \"military strategy\",\n        \"innovation strategy\",\n        \"growth strategy\",\n        \"market strategy\",\n        \"platform strategy\"\n    ],\n\n    \"management\": [\n        \"management\",\n        \"organizational management\",\n        \"operations management\",\n        \"project management\",\n        \"change management\",\n        \"performance management\",\n        \"risk management\",\n        \"quality management\",\n        \"process management\",\n        \"lean management\"\n    ],\n\n    \"leadership\": [\n        \"leadership\",\n        \"executive leadership\",\n        \"transformational leadership\",\n        \"servant leadership\",\n        \"organizational leadership\",\n        \"team leadership\",\n        \"strategic leadership\",\n        \"leadership development\",\n        \"decision leadership\",\n        \"crisis leadership\"\n    ],\n\n    # ========================================\n    # EMPREENDEDORISMO\n    # ========================================\n\n    \"entrepreneurship\": [\n        \"entrepreneurship\",\n        \"startups\",\n        \"venture capital\",\n        \"innovation management\",\n        \"business innovation\",\n        \"founder mindset\",\n        \"startup strategy\",\n        \"scaling startups\",\n        \"product-market fit\",\n        \"entrepreneurial finance\"\n    ],\n\n    \"innovation\": [\n        \"innovation\",\n        \"disruptive innovation\",\n        \"technology innovation\",\n        \"innovation ecosystems\",\n        \"innovation strategy\",\n        \"product innovation\",\n        \"design thinking\",\n        \"business experimentation\",\n        \"innovation leadership\",\n        \"digital transformation\"\n    ],\n\n    # ========================================\n    # DECISÃO & COMPORTAMENTO\n    # ========================================\n\n    \"decision_making\": [\n        \"decision making\",\n        \"managerial decision making\",\n        \"strategic decision making\",\n        \"decision analysis\",\n        \"decision theory\",\n        \"decision science\",\n        \"complex decision making\",\n        \"data driven decision making\",\n        \"risk decision making\",\n        \"executive decisions\"\n    ],\n\n    \"behavioral_economics\": [\n        \"behavioral economics\",\n        \"behavioral finance\",\n        \"economic psychology\",\n        \"choice architecture\",\n        \"bounded rationality\",\n        \"prospect theory\",\n        \"nudging\",\n        \"cognitive biases\",\n        \"heuristics\",\n        \"experimental economics\"\n    ],\n\n    \"psychology_business\": [\n        \"business psychology\",\n        \"organizational psychology\",\n        \"industrial psychology\",\n        \"consumer psychology\",\n        \"economic psychology\",\n        \"workplace psychology\",\n        \"behavioral decision making\",\n        \"motivation psychology\",\n        \"performance psychology\",\n        \"negotiation psychology\"\n    ],\n\n    # ========================================\n    # PRODUTIVIDADE & EXECUÇÃO\n    # ========================================\n\n    \"productivity\": [\n        \"productivity\",\n        \"time management\",\n        \"personal productivity\",\n        \"focus\",\n        \"deep work\",\n        \"goal setting\",\n        \"execution\",\n        \"workflow optimization\",\n        \"high performance\",\n        \"self management\"\n    ],\n\n    \"habits\": [\n        \"habits\",\n        \"behavior change\",\n        \"habit formation\",\n        \"self discipline\",\n        \"routine building\",\n        \"personal development\",\n        \"success habits\",\n        \"mindset\",\n        \"self improvement\",\n        \"life design\"\n    ],\n\n    # ========================================\n    # FILOSOFIA APLICADA\n    # ========================================\n\n    \"philosophy\": [\n        \"philosophy\",\n        \"practical philosophy\",\n        \"applied philosophy\",\n        \"philosophy of economics\",\n        \"philosophy of business\",\n        \"modern philosophy\",\n        \"classical philosophy\",\n        \"rationalism\",\n        \"empiricism\",\n        \"existentialism\"\n    ],\n\n    \"stoicism\": [\n        \"stoicism\",\n        \"stoic philosophy\",\n        \"roman stoicism\",\n        \"practical stoicism\",\n        \"stoic ethics\",\n        \"stoic leadership\",\n        \"stoic resilience\",\n        \"stoic mindset\",\n        \"epictetus\",\n        \"seneca philosophy\"\n    ],\n\n    \"ethics\": [\n        \"ethics\",\n        \"business ethics\",\n        \"economic ethics\",\n        \"corporate ethics\",\n        \"moral philosophy\",\n        \"applied ethics\",\n        \"virtue ethics\",\n        \"leadership ethics\",\n        \"professional ethics\",\n        \"ethics decision making\"\n    ],\n\n    \"political_philosophy\": [\n        \"political philosophy\",\n        \"political economy\",\n        \"liberalism\",\n        \"capitalism\",\n        \"socialism\",\n        \"libertarianism\",\n        \"state theory\",\n        \"governance theory\",\n        \"public choice\",\n        \"freedom philosophy\"\n    ],\n\n    # ========================================\n    # BIOGRAFIA & HISTÓRIA EMPRESARIAL\n    # ========================================\n\n    \"biography_business\": [\n        \"business biography\",\n        \"entrepreneur biography\",\n        \"founder biography\",\n        \"executive biography\",\n        \"corporate history\",\n        \"company history\",\n        \"startup biography\",\n        \"investor biography\",\n        \"ceo biography\",\n        \"business memoir\"\n    ],\n\n    \"economic_history\": [\n        \"economic history\",\n        \"financial history\",\n        \"history of capitalism\",\n        \"history of markets\",\n        \"industrial history\",\n        \"banking history\",\n        \"trade history\",\n        \"corporate history\",\n        \"global economic history\",\n        \"history of economic thought\"\n    ],\n\n    # ========================================\n    # FICÇÃO\n    # ========================================\n\n    \"fiction_general\": [\n        \"fiction\",\n        \"literary fiction\",\n        \"contemporary fiction\",\n        \"modern fiction\",\n        \"world fiction\",\n        \"translated fiction\",\n        \"award winning fiction\",\n        \"classic fiction\",\n        \"bestseller fiction\",\n        \"adult fiction\"\n    ],\n\n    \"science_fiction\": [\n        \"science fiction\",\n        \"hard science fiction\",\n        \"space opera\",\n        \"dystopian fiction\",\n        \"post apocalyptic fiction\",\n        \"time travel fiction\",\n        \"cyberpunk\",\n        \"alien invasion fiction\",\n        \"futuristic fiction\",\n        \"speculative science fiction\"\n    ],\n\n    \"fantasy\": [\n        \"fantasy\",\n        \"epic fantasy\",\n        \"high fantasy\",\n        \"dark fantasy\",\n        \"urban fantasy\",\n        \"sword and sorcery\",\n        \"mythological fantasy\",\n        \"portal fantasy\",\n        \"grimdark fantasy\",\n        \"heroic fantasy\"\n    ],\n\n    \"horror\": [\n        \"horror\",\n        \"psychological horror\",\n        \"supernatural horror\",\n        \"gothic horror\",\n        \"cosmic horror\",\n        \"monster horror\",\n        \"paranormal horror\",\n        \"occult horror\",\n        \"slasher fiction\",\n        \"dark suspense\"\n    ],\n\n    \"mystery_thriller\": [\n        \"mystery\",\n        \"detective fiction\",\n        \"crime fiction\",\n        \"thriller\",\n        \"psychological thriller\",\n        \"legal thriller\",\n        \"spy thriller\",\n        \"noir fiction\",\n        \"police procedural\",\n        \"suspense fiction\"\n    ],\n\n    \"romance\": [\n        \"romance\",\n        \"contemporary romance\",\n        \"historical romance\",\n        \"romantic comedy\",\n        \"dark romance\",\n        \"paranormal romance\",\n        \"erotic romance\",\n        \"romantic drama\",\n        \"second chance romance\",\n        \"young adult romance\"\n    ],\n\n    \"historical_fiction\": [\n        \"historical fiction\",\n        \"war fiction\",\n        \"period fiction\",\n        \"historical drama\",\n        \"alternate history\",\n        \"historical adventure\",\n        \"medieval fiction\",\n        \"renaissance fiction\",\n        \"world war fiction\",\n        \"ancient history fiction\"\n    ],\n\n    \"adventure\": [\n        \"adventure fiction\",\n        \"action adventure\",\n        \"survival fiction\",\n        \"exploration fiction\",\n        \"treasure hunt fiction\",\n        \"nautical fiction\",\n        \"jungle adventure\",\n        \"expedition fiction\",\n        \"pulp adventure\",\n        \"heroic adventure\"\n    ],\n\n    \"young_adult\": [\n        \"young adult fiction\",\n        \"ya fantasy\",\n        \"ya romance\",\n        \"ya dystopian\",\n        \"ya adventure\",\n        \"teen fiction\",\n        \"coming of age fiction\",\n        \"ya science fiction\",\n        \"ya mystery\",\n        \"ya paranormal\"\n    ],\n\n    \"children_fiction\": [\n        \"children fiction\",\n        \"middle grade fiction\",\n        \"kids adventure\",\n        \"children fantasy\",\n        \"children mystery\",\n        \"bedtime stories\",\n        \"illustrated fiction\",\n        \"children classics\",\n        \"early readers fiction\",\n        \"juvenile fiction\"\n    ],\n\n    \"classics_fiction\": [\n        \"classic literature\",\n        \"literary classics\",\n        \"19th century fiction\",\n        \"victorian fiction\",\n        \"american classics\",\n        \"russian classics\",\n        \"french classics\",\n        \"british classics\",\n        \"modern classics\",\n        \"canonical literature\"\n    ],\n\n    \"graphic_novels\": [\n        \"graphic novels\",\n        \"comic books\",\n        \"manga\",\n        \"manhwa\",\n        \"superhero fiction\",\n        \"indie comics\",\n        \"fantasy comics\",\n        \"sci fi comics\",\n        \"horror comics\",\n        \"literary graphic novels\"\n    ]\n}\n",
    "scripts\\_backup\\ingest_books.py": "import requests\nimport uuid\nimport re\nimport unicodedata\nimport time\nimport threading\nfrom datetime import datetime\n\n# =========================\n# CONFIG\n# =========================\n\nSUPABASE_URL = \"https://ncnexkuiiuzwujqurtsa.supabase.co\"\nSUPABASE_KEY = \"SUA_SERVICE_ROLE_KEY\"\n\nHEADERS = {\n    \"apikey\": SUPABASE_KEY,\n    \"Authorization\": f\"Bearer {SUPABASE_KEY}\",\n    \"Content-Type\": \"application/json\"\n}\n\nOPENLIBRARY_SEARCH_URL = \"https://openlibrary.org/search.json\"\nOPENLIBRARY_BASE_URL = \"https://openlibrary.org\"\nGOOGLE_BOOKS_URL = \"https://www.googleapis.com/books/v1/volumes\"\n\nOLLAMA_URL = \"http://localhost:11434/api/generate\"\nMODEL = \"phi3:mini\"\n\nLIMIT_PER_QUERY = 10\n\nQUERIES = [\n    \"finance\",\"investing\",\"personal finance\",\"wealth\",\n    \"entrepreneurship\",\"business strategy\",\n    \"psychology\",\"behavioral economics\",\n    \"decision making\",\"habits\",\"productivity\",\n    \"stoicism\",\"philosophy\",\"ethics\",\n    \"political philosophy\",\"strategy\",\n    \"biography business\",\"entrepreneur biography\",\n    \"leadership\",\"management\",\n]\n\nlast_activity = time.time()\n\n# =========================\n# LOGGER\n# =========================\n\ndef log(msg):\n    now = datetime.now().strftime(\"%H:%M:%S\")\n    print(f\"[{now}] {msg}\")\n\n# =========================\n# HEARTBEAT\n# =========================\n\ndef heartbeat():\n    while True:\n        elapsed = int(time.time() - last_activity)\n        log(f\"Script ativo… último evento há {elapsed}s\")\n        time.sleep(30)\n\nthreading.Thread(target=heartbeat, daemon=True).start()\n\n# =========================\n# SLUG\n# =========================\n\ndef slugify(text):\n    text = unicodedata.normalize(\"NFKD\", text)\n    text = text.encode(\"ascii\", \"ignore\").decode(\"ascii\")\n    text = text.lower()\n    text = re.sub(r\"[^a-z0-9\\s-]\", \"\", text)\n    text = re.sub(r\"\\s+\", \"-\", text)\n    return text.strip(\"-\")\n\n# =========================\n# FILTRO\n# =========================\n\nEXCLUDED_TERMS = [\n    \"laws\",\"law\",\"bill\",\"act\",\"court\",\n    \"audit\",\"administration\",\"report\",\n    \"government\",\"committee\"\n]\n\ndef is_valid_book(doc):\n\n    title = (doc.get(\"title\") or \"\").lower()\n    authors = doc.get(\"author_name\")\n    edition_count = doc.get(\"edition_count\", 0)\n\n    if len(title) < 5:\n        return False\n\n    if not authors:\n        return False\n\n    if edition_count < 2:\n        return False\n\n    for term in EXCLUDED_TERMS:\n        if term in title:\n            return False\n\n    return True\n\n# =========================\n# DEDUP CORRIGIDO\n# =========================\n\ndef book_exists(slug, isbn):\n\n    url = f\"{SUPABASE_URL}/rest/v1/livros\"\n\n    # ---- slug check\n    res_slug = requests.get(\n        url,\n        headers=HEADERS,\n        params={\n            \"select\": \"id\",\n            \"slug\": f\"eq.{slug}\"\n        }\n    )\n\n    data_slug = res_slug.json()\n\n    if data_slug:\n        log(f\"SKIP slug → {slug}\")\n        return True\n\n    # ---- isbn check\n    if isbn:\n\n        res_isbn = requests.get(\n            url,\n            headers=HEADERS,\n            params={\n                \"select\": \"id\",\n                \"isbn\": f\"eq.{isbn}\"\n            }\n        )\n\n        data_isbn = res_isbn.json()\n\n        if data_isbn:\n            log(f\"SKIP isbn → {isbn}\")\n            return True\n\n    return False\n\n# =========================\n# FETCH\n# =========================\n\ndef fetch_by_query(query):\n\n    log(f\"QUERY → {query}\")\n\n    res = requests.get(\n        OPENLIBRARY_SEARCH_URL,\n        params={\"q\": query, \"limit\": LIMIT_PER_QUERY * 3}\n    )\n\n    docs = res.json().get(\"docs\", [])\n\n    filtered = [\n        d for d in docs if is_valid_book(d)\n    ][:LIMIT_PER_QUERY]\n\n    log(f\"{query} → {len(filtered)} válidos\")\n\n    return filtered\n\n# =========================\n# METADATA OL\n# =========================\n\ndef enrich_openlibrary(work_key):\n\n    if not work_key:\n        return {}\n\n    url = f\"{OPE